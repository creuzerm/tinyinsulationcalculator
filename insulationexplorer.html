<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Insulation Explorer & Calculator</title>
    <meta name="description" content="Explore insulation assemblies and radiant barriers for tiny homes and vans. Visualize heat flow and effective R-values.">
    <meta property="og:title" content="Insulation Explorer & Calculator">
    <meta property="og:description" content="Explore insulation assemblies and radiant barriers for tiny homes and vans. Visualize heat flow and effective R-values.">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://example.com/insulationexplorer.html">
    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="Insulation Explorer & Calculator">
    <meta name="twitter:description" content="Explore insulation assemblies and radiant barriers for tiny homes and vans.">
    <link rel="canonical" href="https://example.com/insulationexplorer.html">
    <link rel="icon" href="data:,">

    <script src="https://cdn.tailwindcss.com?plugins=typography"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="skin.css">
</head>
<body class="bg-gray-100 text-gray-800 font-sans">

    <div class="container mx-auto p-2 md:p-6 max-w-7xl">
        <header class="app-header text-center mb-6 relative">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-900">Insulation Explorer</h1>
            <p class="text-gray-700 mt-2">Design your wall or roof assembly to see how materials interact.</p>

            <!-- Hamburger Menu -->
            <div class="absolute top-0 right-0 p-4">
                <button id="menu-btn" class="text-gray-500 hover:text-gray-700 focus:outline-none" aria-label="Menu">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path>
                    </svg>
                </button>
                <div id="menu-dropdown" class="hidden absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg z-20">
                    <a href="index.html" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Tiny Home Calculator</a>
                    <a href="existing_building_estimator.html" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Existing Building Estimator</a>
                    <a href="insulationexplorer.html" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Insulation Explorer</a>
                </div>
            </div>
        </header>

        <!-- A/B Toggle Switch -->
        <div class="mt-6 flex flex-col items-center justify-center space-y-4 mb-6">
            <label class="inline-flex items-center cursor-pointer bg-white px-4 py-2 rounded-full shadow-sm border border-gray-200">
                <input type="checkbox" id="abToggle" class="sr-only peer" onchange="toggleABMode()">
                <div class="relative w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-blue-600 rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                <span class="ms-3 text-sm font-medium text-gray-700">Enable A/B Comparison</span>
            </label>

            <!-- Share Buttons -->
            <div class="flex justify-center space-x-2">
                <button id="copyLinkBtn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-medium py-2 px-4 rounded-md shadow-sm flex items-center transition-colors duration-200" onclick="copyLink()">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"></path></svg>
                    Copy Link
                </button>
            </div>
        </div>

        <div class="mb-6 text-center max-w-3xl mx-auto">
             <p class="text-sm text-gray-600">Pay special attention to <strong>Radiant Barriers</strong> which behave differently in summer (Heat Down) vs winter (Heat Up).</p>
        </div>

        <div class="explorer-container">
            <!-- Left: Visual Stack -->
            <div class="stack-section">
                <div class="heat-flow-arrow">
                    <span>‚òÄÔ∏è OUTSIDE (Hot/Cold)</span>
                </div>
                
                <div id="stack-container-A">
                    <h3 class="text-center font-bold text-blue-800 mb-2 hidden" id="label-A">Scenario A</h3>
                    <div id="assembly-stack-A" class="assembly-stack shadow-lg">
                        <div class="assembly-header">Exterior Air Film</div>
                        <!-- Layers generate here -->
                    </div>
                </div>

                <div id="stack-container-B" class="hidden mt-6">
                    <h3 class="text-center font-bold text-green-800 mb-2" id="label-B">Scenario B</h3>
                    <div id="assembly-stack-B" class="assembly-stack shadow-lg border-green-500 border-4">
                        <div class="assembly-header">Exterior Air Film</div>
                        <!-- Layers generate here -->
                    </div>
                </div>

                <div class="heat-flow-arrow">
                    <span>üè† INSIDE (Conditioned)</span>
                </div>
            </div>

            <!-- Right: Controls & Stats -->
            <div class="dashboard shadow-md" aria-live="polite">
                <!-- Stats A -->
                <div id="stats-A" class="stat-card border-l-4 border-blue-500">
                    <div class="font-semibold text-gray-700">Effective R-Value (A)</div>
                    <div style="display: flex; justify-content: space-around; margin-top:10px;">
                        <div>
                            <div class="stat-value" id="r-value-winter-A">0</div>
                            <div class="stat-sub">Winter (Heat Up)</div>
                        </div>
                        <div>
                            <div class="stat-value" id="r-value-summer-A">0</div>
                            <div class="stat-sub">Summer (Heat Down)</div>
                        </div>
                    </div>
                    <div id="inspector-A" class="inspector-panel rounded-md mt-2">
                        <strong>Inspector Notes:</strong><br>
                        Start by adding a structural layer or sheathing.
                    </div>
                    <div id="warnings-A" class="inspector-warning rounded-md" style="display:none;"></div>
                </div>

                <!-- Stats B (Hidden) -->
                <div id="stats-B" class="stat-card border-l-4 border-green-500 hidden">
                    <div class="font-semibold text-gray-700">Effective R-Value (B)</div>
                    <div style="display: flex; justify-content: space-around; margin-top:10px;">
                        <div>
                            <div class="stat-value" id="r-value-winter-B">0</div>
                            <div class="stat-sub">Winter (Heat Up)</div>
                        </div>
                        <div>
                            <div class="stat-value" id="r-value-summer-B">0</div>
                            <div class="stat-sub">Summer (Heat Down)</div>
                        </div>
                    </div>
                    <div id="inspector-B" class="inspector-panel rounded-md mt-2">
                        <strong>Inspector Notes:</strong><br>
                        Start by adding a structural layer or sheathing.
                    </div>
                    <div id="warnings-B" class="inspector-warning rounded-md" style="display:none;"></div>
                </div>

                <h3 class="font-bold text-gray-700 mt-2">Add Layer</h3>

                <!-- Target Selector -->
                <div id="target-selector" class="flex space-x-2 mb-2 hidden">
                    <button id="btn-target-A" class="flex-1 py-1 px-2 rounded bg-blue-100 text-blue-800 font-bold border border-blue-300" onclick="setTarget('A')">Scenario A</button>
                    <button id="btn-target-B" class="flex-1 py-1 px-2 rounded bg-gray-100 text-gray-600 border border-gray-300 hover:bg-green-50" onclick="setTarget('B')">Scenario B</button>
                </div>

                <div id="material-menu" class="add-menu">
                    <p class="col-span-full text-center text-gray-500 py-4">Loading materials...</p>
                </div>
                
                <button class="button w-full mt-5 bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded shadow transition-colors" onclick="resetStack()">Reset Active Stack</button>
            </div>
        </div>
        
        <div class="mt-10 bg-white p-6 rounded-lg shadow-md">
            <h2 class="text-xl font-bold text-gray-800 mb-4">üí° Pro Tips: Reflectix & Radiant Barriers</h2>
            <p class="mb-4 text-gray-700">Reflectix and other radiant barriers work by <strong>reflecting</strong> radiant heat, not just slowing conduction. For them to work, they MUST face an air space.</p>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="bg-green-50 p-4 rounded border border-green-200">
                    <h3 class="font-bold text-green-800 mb-2">‚úÖ Correct Installation</h3>
                    <p class="font-mono text-sm mb-2 bg-white p-1 rounded inline-block border border-green-100">Roof Deck -> Air Gap -> Reflectix -> Insulation</p>
                    <p class="text-sm text-gray-700">The foil surface faces an empty air gap (at least 0.75"). This allows the foil to reflect heat back up (summer) or emit very little heat down.</p>
                </div>
                <div class="bg-red-50 p-4 rounded border border-red-200">
                    <h3 class="font-bold text-red-800 mb-2">‚ùå Incorrect Installation</h3>
                    <p class="font-mono text-sm mb-2 bg-white p-1 rounded inline-block border border-red-100">Sandwiched (Zero Gap)</p>
                    <p class="text-sm text-gray-700">If you sandwich Reflectix between two solid layers (like roof deck and fiberglass) with no air gap, its R-value drops to ~1.1 (just the plastic bubbles). It becomes a conductor, not a reflector.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Logic Engine -->
    <script type="module" src="webmcp.js"></script>
    <script src="insulation_calculator.js"></script>
    <script>
        // Global Data
        let MATERIALS = {};
        let stacks = { A: [], B: [] };
        let activeStackId = 'A';

        // Fetch data and initialize
        async function loadMaterials() {
            try {
                const response = await fetch('materials.json');
                if (!response.ok) throw new Error('Failed to load materials.json');
                const data = await response.json();

                // Flatten the structured JSON into a single lookup object for calculation logic
                MATERIALS = {};
                const menuContainer = document.getElementById('material-menu');
                menuContainer.innerHTML = ''; // Clear loading message

                // Iterate through categories to build UI and lookup table
                for (const [category, items] of Object.entries(data)) {
                    // Create Category Header
                    const header = document.createElement('h4');
                    header.className = 'col-span-full font-semibold text-xs text-gray-500 uppercase tracking-wider mt-2 mb-1 border-b pb-1';
                    header.textContent = category;
                    menuContainer.appendChild(header);

                    // Create Buttons
                    for (const [key, material] of Object.entries(items)) {
                        // Add to lookup
                        MATERIALS[key] = material;

                        // Add Button (skip placeholders if desired, but here we render them if they are valid options)
                        // If placeholder property exists and is true, we might want to disable it or mark it.
                        // For now, per requirements, we just render them.
                        const btn = document.createElement('button');
                        btn.className = 'add-btn shadow-sm transition-colors';
                        btn.onclick = () => addLayer(key);
                        btn.setAttribute('aria-label', `Add ${material.name}`);

                        // Icon mapping based on type
                        let icon = "üß±";
                        if(material.type === 'insulation') icon = "üü¶";
                        if(material.name.includes("Fiberglass")) icon = "üß∂";
                        if(material.name.includes("Rockwool")) icon = "ü™®";
                        if(material.name.includes("Polyiso")) icon = "üü®";
                        if(material.name.includes("EPS")) icon = "‚¨ú";
                        if(material.name.includes("Spray")) icon = "üí®";
                        if(material.type === 'radiant') icon = "‚ú®";
                        if(material.type === 'air') icon = "üí®";
                        if(material.type === 'vapor') icon = "üõ°Ô∏è";
                        if(material.type === 'sheathing') icon = "ü™µ";
                        if(material.type === 'finish') icon = "‚¨ú";
                        if(key.includes("Roof")) icon = "üè†";

                        btn.innerText = `${icon} ${material.name.replace(/Rigid Foam|Board|Spray Foam|Batt|Safe'n'Sound|ComfortBatt/g, "").replace(/\(.*\)/, "").trim()} (${material.thickness}")`;

                        // Override concise labels for specific known items to match previous design if needed,
                        // or just use the generated one which is robust.
                        // Let's stick to the generated one for simplicity and consistency.

                        if (material.placeholder) {
                            btn.disabled = true;
                            btn.classList.add('opacity-50', 'cursor-not-allowed');
                            btn.title = "Coming Soon";
                        }

                        menuContainer.appendChild(btn);
                    }
                }

                // Initialize Default Stack
                if (!deserializeConfiguration()) {
                    initStack();
                }

            } catch (error) {
                console.error(error);
                document.getElementById('material-menu').innerHTML = `<p class="col-span-full text-red-500">Error loading materials: ${error.message}</p>`;
            }
        }

        function initStack() {
            // Pre-load a common scenario
            stacks.A = [];
            activeStackId = 'A';
            addLayer('OSB Sheathing');
            addLayer('2x6 Stud (16oc)');
            addLayer('Rockwool (5.5in)');
            addLayer('Drywall');
            stacks.B = [];
        }

        function addLayer(key) {
            const material = MATERIALS[key];
            if (!material) return;

            // Create a unique instance
            stacks[activeStackId].push({
                ...material,
                key: key,
                id: crypto.randomUUID()
            });
            render();
        }

        // Start Loading and store promise
        const materialsLoadedPromise = loadMaterials();

        function removeLayer(id) {
            // Find and remove from appropriate stack
            if (stacks.A.some(l => l.id === id)) {
                stacks.A = stacks.A.filter(l => l.id !== id);
            } else if (stacks.B.some(l => l.id === id)) {
                stacks.B = stacks.B.filter(l => l.id !== id);
            }
            render();
        }

        function moveLayer(index, direction, stackId = activeStackId) {
            const currentStack = stacks[stackId];
            if (!currentStack) return;

            if (direction === -1 && index > 0) {
                [currentStack[index], currentStack[index - 1]] = [currentStack[index - 1], currentStack[index]];
            } else if (direction === 1 && index < currentStack.length - 1) {
                [currentStack[index], currentStack[index + 1]] = [currentStack[index + 1], currentStack[index]];
            }
            render();
        }

        function resetStack() {
            stacks[activeStackId] = [];
            render();
        }

        // WebMCP Tool Registration
        // Note: webmcp.js is loaded as a module, so this script might run before it initializes.
        // We can wait for it or just check if it's there.
        // A robust implementation would wait for the 'webmcp-ready' event if one existed,
        // or we can use a small timeout or assume the module loading order.
        // Since we are in an inline script at the bottom of the body, and webmcp.js is a module in the head (or start of body),
        // let's rely on window.navigator.modelContext being present if the polyfill is immediate,
        // OR simply wrap it in a timeout or event listener if the polyfill is async.
        // Looking at webmcp.js (from memory), it polyfills navigator.modelContext immediately if it's not dynamic import.

        window.addEventListener('load', async () => {
             // Wait for materials to load so tool registration has correct enum
             await materialsLoadedPromise;

             // Menu Toggle Logic
             const menuBtn = document.getElementById('menu-btn');
             const menuDropdown = document.getElementById('menu-dropdown');
             if (menuBtn && menuDropdown) {
                 menuBtn.addEventListener('click', (e) => {
                     e.stopPropagation();
                     menuDropdown.classList.toggle('hidden');
                 });
                 document.addEventListener('click', (event) => {
                    if (!menuDropdown.classList.contains('hidden') && !menuBtn.contains(event.target) && !menuDropdown.contains(event.target)) {
                        menuDropdown.classList.add('hidden');
                    }
                });
             }

             if (window.navigator && window.navigator.modelContext) {
                window.navigator.modelContext.registerTool({
                    name: "calculate_assembly",
                    description: "Calculate the effective R-value (Winter/Summer) of a wall or roof assembly given a list of layers.",
                    inputSchema: {
                        type: "object",
                        properties: {
                            layers: {
                                type: "array",
                                items: {
                                    type: "string",
                                    enum: Object.keys(MATERIALS),
                                    description: "The material key (e.g., '2x4 Stud (16oc)', 'Fiberglass Batt (3.5in)')"
                                },
                                description: "Ordered list of layers from Outside to Inside."
                            }
                        },
                        required: ["layers"]
                    },
                    execute: async (args) => {
                        const tempStack = args.layers.map(key => {
                            const mat = MATERIALS[key];
                            if (!mat) throw new Error(`Unknown material: ${key}`);
                            return { ...mat };
                        });
                        return calculate(tempStack);
                    }
                });
             }
        });

        function render() {
            renderStack('A');
            // Check if A/B is active
            if (document.getElementById('abToggle')?.checked) {
                renderStack('B');
            }
        }

        function renderStack(stackId) {
            const currentStack = stacks[stackId];
            const container = document.getElementById(`assembly-stack-${stackId}`);
            if (!container) return;

            container.innerHTML = '<div class="assembly-header">Exterior Air Film</div>';

            currentStack.forEach((layer, index) => {
                const div = document.createElement('div');
                div.className = `layer layer-type-${layer.type}`;
                div.innerHTML = `
                    <div>
                        <strong>${layer.name}</strong><br>
                        <span style="font-size:0.8em">R-${layer.r} | ${layer.thickness}"</span>
                    </div>
                    <div class="layer-controls">
                        <button onclick="moveLayer(${index}, -1, '${stackId}')" aria-label="Move Up">‚¨ÜÔ∏è</button>
                        <button onclick="moveLayer(${index}, 1, '${stackId}')" aria-label="Move Down">‚¨áÔ∏è</button>
                        <button onclick="removeLayer(${layer.id})" style="color:red" aria-label="Remove Layer">√ó</button>
                    </div>
                `;
                container.appendChild(div);
            });

            const results = calculate(currentStack);

            const rWinterEl = document.getElementById(`r-value-winter-${stackId}`);
            const rSummerEl = document.getElementById(`r-value-summer-${stackId}`);
            if (rWinterEl) rWinterEl.innerText = results.r_winter;
            if (rSummerEl) rSummerEl.innerText = results.r_summer;

            // Inspector
            const inspector = document.getElementById(`inspector-${stackId}`);
            const warningBox = document.getElementById(`warnings-${stackId}`);

            if (results.warnings.length > 0 && warningBox) {
                warningBox.style.display = 'block';
                warningBox.innerHTML = results.warnings.join('<br>');
            } else if (warningBox) {
                warningBox.style.display = 'none';
            }

            // Contextual tips
            let tips = "System looks stable.";
            if (currentStack.some(l => l.type === 'radiant')) {
                tips = "Reflectix Tip: In a 2x6 roof truss, using a 'Double Reflectix' method (two layers with two air gaps) can effectively block summer heat, but takes up about 2.5 inches of space. Ensure you have room!";
            }
            if (currentStack.length === 0) tips = "Start adding layers to see results.";

            if (inspector) inspector.innerHTML = `<strong>Inspector Notes:</strong><br>${tips}`;
        }

        function toggleABMode() {
            const isEnabled = document.getElementById('abToggle').checked;
            const containerB = document.getElementById('stack-container-B');
            const statsB = document.getElementById('stats-B');
            const labelA = document.getElementById('label-A');
            const targetSelector = document.getElementById('target-selector');

            if (isEnabled) {
                containerB.classList.remove('hidden');
                statsB.classList.remove('hidden');
                labelA.classList.remove('hidden');
                targetSelector.classList.remove('hidden');

                // If B is empty, clone A for convenience
                if (stacks.B.length === 0 && stacks.A.length > 0) {
                    stacks.B = stacks.A.map(l => ({ ...l, id: Date.now() + Math.random() }));
                }
            } else {
                containerB.classList.add('hidden');
                statsB.classList.add('hidden');
                labelA.classList.add('hidden');
                targetSelector.classList.add('hidden');
                setTarget('A'); // Reset to A
            }
            render();
        }

        function setTarget(stackId) {
            activeStackId = stackId;

            // UI Feedback
            const btnA = document.getElementById('btn-target-A');
            const btnB = document.getElementById('btn-target-B');

            if (stackId === 'A') {
                btnA.className = "flex-1 py-1 px-2 rounded bg-blue-100 text-blue-800 font-bold border border-blue-300 shadow-inner";
                btnB.className = "flex-1 py-1 px-2 rounded bg-gray-100 text-gray-600 border border-gray-300 hover:bg-green-50";
            } else {
                btnA.className = "flex-1 py-1 px-2 rounded bg-gray-100 text-gray-600 border border-gray-300 hover:bg-blue-50";
                btnB.className = "flex-1 py-1 px-2 rounded bg-green-100 text-green-800 font-bold border border-green-300 shadow-inner";
            }
        }

        function serializeConfiguration() {
            const params = new URLSearchParams();

            const getKeys = (s) => s.map(l => l.key).filter(k => k).join(',');

            if (stacks.A.length > 0) params.set('a', getKeys(stacks.A));
            if (stacks.B.length > 0) params.set('b', getKeys(stacks.B));
            if (document.getElementById('abToggle').checked) params.set('ab', '1');

            return `${window.location.origin}${window.location.pathname}?${params.toString()}`;
        }

        function deserializeConfiguration() {
            const params = new URLSearchParams(window.location.search);
            // If no params, return false to let defaults load
            if (!params.has('a') && !params.has('b') && !params.has('ab')) return false;

            // Clear defaults
            stacks.A = [];
            stacks.B = [];

            const load = (param, stackId) => {
                const keysStr = params.get(param);
                if (keysStr) {
                    activeStackId = stackId; // temp switch to add
                    keysStr.split(',').forEach(key => addLayer(key));
                }
            };

            load('a', 'A');
            load('b', 'B');

            // After loading both stacks, reset the active stack to 'A' to ensure a consistent state.
            activeStackId = 'A';

            if (params.get('ab') === '1') {
                document.getElementById('abToggle').checked = true;
                toggleABMode();
                // Explicitly set the target UI to match the active stack.
                setTarget('A');
            } else {
                render();
            }

            return true;
        }

        function copyLink() {
            const url = serializeConfiguration();
            navigator.clipboard.writeText(url).then(() => {
                const btn = document.getElementById('copyLinkBtn');
                const originalHTML = btn.innerHTML;
                btn.innerHTML = `<svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg> Copied!`;
                setTimeout(() => {
                    btn.innerHTML = originalHTML;
                }, 2000);
            }).catch(err => {
                console.error('Failed to copy: ', err);
                alert('Failed to copy URL to clipboard');
            });
        }

    </script>
    <script src="skin.js"></script>
</body>
</html>