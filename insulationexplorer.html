<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Insulation Explorer & Calculator</title>
    <link rel="stylesheet" href="skin.css">
    <link rel="stylesheet" href="styles.css">
    <style>
        /* Explorer Specific Styles */
        :root {
            --insulation-batts: #f4eeb1;
            --insulation-rigid: #a8d5e2;
            --insulation-spray: #fceea7;
            --insulation-radiant: #e0e0e0;
            --structure: #cfb997;
            --air: #f0f8ff;
        }

        .explorer-container {
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 20px;
            margin-top: 20px;
        }

        @media (max-width: 800px) {
            .explorer-container {
                grid-template-columns: 1fr;
            }
        }

        /* The Visual Stack */
        .assembly-stack {
            background: #fff;
            border: 2px solid var(--primary-color);
            border-radius: var(--border-radius);
            padding: 20px;
            min-height: 400px;
            display: flex;
            flex-direction: column;
            position: relative;
            overflow: hidden;
        }

        .assembly-header {
            text-align: center;
            font-weight: bold;
            color: #666;
            margin-bottom: 10px;
            text-transform: uppercase;
            font-size: 0.8rem;
            border-bottom: 1px dashed #ccc;
            padding-bottom: 5px;
        }

        .layer {
            position: relative;
            padding: 15px;
            margin-bottom: 2px;
            border: 1px solid #ccc;
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.2s;
            font-family: monospace;
            cursor: grab;
        }

        .layer:hover {
            transform: scale(1.01);
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        /* Layer Types Visualization */
        .layer-type-structure { background: repeating-linear-gradient(45deg, #deb887, #deb887 10px, #d2a679 10px, #d2a679 20px); color: #fff; text-shadow: 0 1px 2px rgba(0,0,0,0.5); }
        .layer-type-insulation { background-color: var(--insulation-batts); background-image: url('data:image/svg+xml;utf8,<svg width="20" height="20" xmlns="http://www.w3.org/2000/svg"><path d="M0 10 Q5 0 10 10 T20 10" stroke="%23d4c57e" fill="none"/></svg>'); }
        .layer-type-radiant { background: linear-gradient(135deg, #e0e0e0 0%, #ffffff 50%, #d6d6d6 100%); border: 1px solid #999; color: #333; }
        .layer-type-air { background: var(--air); border: 1px dashed #aad; color: #668; }
        .layer-type-sheathing { background: #d2b48c; }
        .layer-type-finish { background: #fdfdfd; border: 1px solid #eee; }

        .layer-controls button {
            background: none;
            border: none;
            cursor: pointer;
            opacity: 0.5;
            font-size: 1.2rem;
            padding: 0 5px;
        }
        .layer-controls button:hover { opacity: 1; color: var(--accent-color); }

        /* Controls & Dashboard */
        .dashboard {
            background: #f8f9fa;
            border-radius: var(--border-radius);
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            height: fit-content;
        }

        .stat-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            text-align: center;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: var(--primary-color);
        }
        
        .stat-sub { font-size: 0.8rem; color: #666; }

        .inspector-panel {
            background: #eef;
            border-left: 4px solid var(--accent-color);
            padding: 10px;
            font-size: 0.9rem;
        }
        
        .inspector-warning {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 10px;
            margin-top: 10px;
            font-size: 0.9rem;
        }

        .add-menu {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 5px;
        }

        .add-btn {
            padding: 8px;
            font-size: 0.8rem;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
            text-align: left;
        }
        .add-btn:hover { background: #f0f0f0; border-color: #bbb; }

        .heat-flow-arrow {
            text-align: center;
            font-weight: bold;
            color: var(--accent-color);
            margin: 10px 0;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
    </style>
</head>
<body>

    <header>
        <div class="logo">
            <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M2 22h20M12 2L2 12h3v8h4v-6h6v6h4v-8h3z"/>
            </svg>
            <span>Tiny Insulation Calculator</span>
        </div>
        <nav>
            <a href="index.html">Main Calculator</a>
            <a href="existing_building_estimator.html">Retrofit Tool</a>
            <a href="#" class="active">Explorer</a>
        </nav>
    </header>

    <div class="container">
        <h1>Insulation Explorer</h1>
        <p>Design your wall or roof assembly to see how materials interact. Pay special attention to <strong>Radiant Barriers</strong> which behave differently in summer (Heat Down) vs winter (Heat Up).</p>

        <div class="explorer-container">
            <!-- Left: Visual Stack -->
            <div class="stack-section">
                <div class="heat-flow-arrow">
                    <span>‚òÄÔ∏è OUTSIDE (Hot/Cold)</span>
                </div>
                
                <div id="assembly-stack" class="assembly-stack">
                    <div class="assembly-header">Exterior Air Film</div>
                    <!-- Layers generate here -->
                </div>

                <div class="heat-flow-arrow">
                    <span>üè† INSIDE (Conditioned)</span>
                </div>
            </div>

            <!-- Right: Controls & Stats -->
            <div class="dashboard">
                <div class="stat-card">
                    <div>Effective R-Value</div>
                    <div style="display: flex; justify-content: space-around; margin-top:10px;">
                        <div>
                            <div class="stat-value" id="r-value-winter">0</div>
                            <div class="stat-sub">Winter (Heat Up)</div>
                        </div>
                        <div>
                            <div class="stat-value" id="r-value-summer">0</div>
                            <div class="stat-sub">Summer (Heat Down)</div>
                        </div>
                    </div>
                </div>

                <div id="inspector" class="inspector-panel">
                    <strong>Inspector Notes:</strong><br>
                    Start by adding a structural layer or sheathing.
                </div>

                <div id="warnings" class="inspector-warning" style="display:none;"></div>

                <h3>Add Layer</h3>
                <div class="add-menu">
                    <!-- Structure -->
                    <button class="add-btn" onclick="addLayer('2x4 Stud (16oc)')">üß± 2x4 Wood Stud</button>
                    <button class="add-btn" onclick="addLayer('2x6 Stud (16oc)')">üß± 2x6 Wood Stud</button>
                    <button class="add-btn" onclick="addLayer('2x10 Joist')">üß± 2x10 Joist</button>
                    
                    <!-- Insulation -->
                    <button class="add-btn" onclick="addLayer('Fiberglass Batt (3.5in)')">üß∂ Fiberglass R-13</button>
                    <button class="add-btn" onclick="addLayer('Rockwool (3.5in)')">ü™® Rockwool R-15</button>
                    <button class="add-btn" onclick="addLayer('Rockwool (5.5in)')">ü™® Rockwool R-23</button>
                    
                    <!-- Radiant/Films -->
                    <button class="add-btn" onclick="addLayer('Reflectix Radiant Barrier')">‚ú® Reflectix Layer</button>
                    <button class="add-btn" onclick="addLayer('Air Gap (0.75in)')">üí® Air Gap (3/4")</button>
                    <button class="add-btn" onclick="addLayer('Poly Vapor Barrier')">üõ°Ô∏è Poly Sheet</button>

                    <!-- Sheathing/Finish -->
                    <button class="add-btn" onclick="addLayer('OSB Sheathing')">ü™µ OSB (1/2")</button>
                    <button class="add-btn" onclick="addLayer('Drywall')">‚¨ú Drywall (1/2")</button>
                </div>
                
                <button class="button" style="width:100%; margin-top:20px; background:#e74c3c;" onclick="resetStack()">Reset Assembly</button>
            </div>
        </div>
        
        <div style="margin-top: 40px; background: white; padding: 20px; border-radius: 8px;">
            <h2>üí° Pro Tips: Reflectix & Radiant Barriers</h2>
            <p>Reflectix and other radiant barriers work by <strong>reflecting</strong> radiant heat, not just slowing conduction. For them to work, they MUST face an air space.</p>
            
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px; margin-top:20px;">
                <div>
                    <h3>‚úÖ Correct Installation</h3>
                    <p><strong>Roof Deck -> Air Gap -> Reflectix -> Insulation</strong></p>
                    <p>The foil surface faces an empty air gap (at least 0.75"). This allows the foil to reflect heat back up (summer) or emit very little heat down.</p>
                </div>
                <div>
                    <h3>‚ùå Incorrect Installation</h3>
                    <p><strong>Sandwiched (Zero Gap)</strong></p>
                    <p>If you sandwich Reflectix between two solid layers (like roof deck and fiberglass) with no air gap, its R-value drops to ~1.1 (just the plastic bubbles). It becomes a conductor, not a reflector.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Logic Engine -->
    <script>
        // Database of Materials
        // r_per_inch: conductive resistance
        // type: category for logic
        // thickness: default thickness in inches
        const MATERIALS = {
            '2x4 Stud (16oc)': { r: 4.5, type: 'structure', thickness: 3.5, name: '2x4 Wood Stud Wall (16" o.c.)' },
            '2x6 Stud (16oc)': { r: 6.9, type: 'structure', thickness: 5.5, name: '2x6 Wood Stud Wall (16" o.c.)' },
            '2x10 Joist': { r: 11.25, type: 'structure', thickness: 9.25, name: '2x10 Roof Joist' },
            'Fiberglass Batt (3.5in)': { r: 13, type: 'insulation', thickness: 3.5, name: 'Fiberglass Batt (R-13)' },
            'Rockwool (3.5in)': { r: 15, type: 'insulation', thickness: 3.5, name: 'Rockwool Safe\'n\'Sound (R-15)' },
            'Rockwool (5.5in)': { r: 23, type: 'insulation', thickness: 5.5, name: 'Rockwool ComfortBatt (R-23)' },
            'Reflectix Radiant Barrier': { r: 1.1, type: 'radiant', thickness: 0.3, name: 'Reflectix (Double Bubble)' },
            'Air Gap (0.75in)': { r: 0.9, type: 'air', thickness: 0.75, name: 'Dead Air Space (0.75")' },
            'Poly Vapor Barrier': { r: 0, type: 'vapor', thickness: 0.01, name: '6-mil Polyethylene' },
            'OSB Sheathing': { r: 0.6, type: 'sheathing', thickness: 0.5, name: 'OSB Sheathing (1/2")' },
            'Drywall': { r: 0.45, type: 'finish', thickness: 0.5, name: 'Gypsum Board (1/2")' }
        };

        // State
        let stack = [];

        function init() {
            // Pre-load a common scenario
            addLayer('OSB Sheathing');
            addLayer('2x6 Stud (16oc)');
            addLayer('Rockwool (5.5in)');
            addLayer('Drywall');
        }

        function addLayer(key) {
            const material = MATERIALS[key];
            if(!material) return;
            
            // Create a unique instance
            stack.push({
                ...material,
                id: Date.now() + Math.random()
            });
            render();
        }

        function removeLayer(id) {
            stack = stack.filter(l => l.id !== id);
            render();
        }

        function moveLayer(index, direction) {
            if (direction === -1 && index > 0) {
                [stack[index], stack[index - 1]] = [stack[index - 1], stack[index]];
            } else if (direction === 1 && index < stack.length - 1) {
                [stack[index], stack[index + 1]] = [stack[index + 1], stack[index]];
            }
            render();
        }

        function resetStack() {
            stack = [];
            render();
        }

        // The Physics Engine
        function calculate() {
            let totalR_winter = 0;
            let totalR_summer = 0;
            let warnings = [];
            let notes = [];
            
            // Basic air films (Exterior + Interior)
            totalR_winter += 0.85; 
            totalR_summer += 0.85; // simplified

            // Scan stack for context
            stack.forEach((layer, index) => {
                let r_up = layer.r; // Heat flow up (Winter)
                let r_down = layer.r; // Heat flow down (Summer)
                let layerNote = "";

                // --- LOGIC: Radiant Barriers ---
                if (layer.type === 'radiant') {
                    // Check neighbors for air gap
                    const prev = stack[index - 1];
                    const next = stack[index + 1];
                    const hasAirGap = (prev && prev.type === 'air') || (next && next.type === 'air');

                    if (hasAirGap) {
                        // Radiant Barrier ACTIVE
                        // Values approximate ASHRAE fundamentals for bright foil w/ air space
                        
                        // Heat Flow DOWN (Summer): Radiant barriers excel here
                        r_down = 10.0; // Effective R-value of the assembly boost
                        
                        // Heat Flow UP (Winter): Convection dominates, radiation less factor
                        r_up = 5.0; 
                        
                        layerNote = "ACTIVE (Reflecting Heat)";
                    } else {
                        // Radiant Barrier INACTIVE (Conduction only)
                        r_down = 1.1;
                        r_up = 1.1;
                        warnings.push(`Radiant layer at position ${index + 1} has no air gap! It is acting as a conductor only.`);
                        layerNote = "INACTIVE (No Air Gap)";
                    }
                }

                // --- LOGIC: Air Gaps ---
                if (layer.type === 'air') {
                    // Air gap R-value depends on facing surfaces. 
                    // If next to radiant, the radiant layer claims the bonus, keep air nominal
                    // to avoid double counting.
                    r_up = 0.9;
                    r_down = 0.9;
                }

                // --- LOGIC: Framing Factor (Thermal Bridging) ---
                // If we have insulation AND structure in the stack, we are strictly adding them linearly here
                // But in reality, studs bridge the insulation.
                // For this simple explorer, we will treat "Structure" layers as defining the cavity depth
                // If a user adds "2x6 Stud" AND "Rockwool", they are occupying the same space visually in this stacker
                // but physically they merge.
                // TO FIX: We will treat the stack as a literal sequence through the center of the bay, 
                // but warn if thickness doesn't match.
                
                totalR_winter += r_up;
                totalR_summer += r_down;
            });

            // Logic: Check thickness conflicts
            // E.g. 2x6 stud (5.5") + Rockwool (5.5") + Reflectix + Air Gap
            // If the user adds framing, we assume they are building the cavity. 
            // If total insulation thickness > structure thickness, warn.
            const structureLayer = stack.find(l => l.type === 'structure');
            const insulationThickness = stack.filter(l => l.type === 'insulation' || l.type === 'air').reduce((sum, l) => sum + l.thickness, 0);
            
            if (structureLayer && insulationThickness > structureLayer.thickness) {
                warnings.push(`<b>Compression Warning:</b> Your insulation + air gaps (${insulationThickness}") are thicker than your framing (${structureLayer.thickness}"). Compressing insulation reduces R-value and eliminates air gaps.`);
            }

            return { r_winter: totalR_winter.toFixed(1), r_summer: totalR_summer.toFixed(1), warnings, notes };
        }

        function render() {
            const container = document.getElementById('assembly-stack');
            container.innerHTML = '<div class="assembly-header">Exterior Air Film</div>';

            stack.forEach((layer, index) => {
                const div = document.createElement('div');
                div.className = `layer layer-type-${layer.type}`;
                div.innerHTML = `
                    <div>
                        <strong>${layer.name}</strong><br>
                        <span style="font-size:0.8em">R-${layer.r} | ${layer.thickness}"</span>
                    </div>
                    <div class="layer-controls">
                        <button onclick="moveLayer(${index}, -1)">‚¨ÜÔ∏è</button>
                        <button onclick="moveLayer(${index}, 1)">‚¨áÔ∏è</button>
                        <button onclick="removeLayer(${layer.id})" style="color:red">√ó</button>
                    </div>
                `;
                container.appendChild(div);
            });

            const results = calculate();
            
            document.getElementById('r-value-winter').innerText = results.r_winter;
            document.getElementById('r-value-summer').innerText = results.r_summer;

            // Inspector
            const inspector = document.getElementById('inspector');
            const warningBox = document.getElementById('warnings');
            
            if (results.warnings.length > 0) {
                warningBox.style.display = 'block';
                warningBox.innerHTML = results.warnings.join('<br>');
            } else {
                warningBox.style.display = 'none';
            }

            // Contextual tips
            let tips = "System looks stable.";
            if (stack.some(l => l.type === 'radiant')) {
                tips = "Reflectix Tip: In a 2x6 roof truss, using a 'Double Reflectix' method (two layers with two air gaps) can effectively block summer heat, but takes up about 2.5 inches of space. Ensure you have room!";
            }
            if (stack.length === 0) tips = "Start adding layers to see results.";
            
            inspector.innerHTML = `<strong>Inspector Notes:</strong><br>${tips}`;
        }

        // Init
        init();

    </script>
</body>
</html>