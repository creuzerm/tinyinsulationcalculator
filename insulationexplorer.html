<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Insulation Explorer & Calculator</title>
    <meta name="description" content="Explore insulation assemblies and radiant barriers for tiny homes and vans. Visualize heat flow and effective R-values.">
    <meta property="og:title" content="Insulation Explorer & Calculator">
    <meta property="og:description" content="Explore insulation assemblies and radiant barriers for tiny homes and vans. Visualize heat flow and effective R-values.">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://example.com/insulationexplorer.html">
    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="Insulation Explorer & Calculator">
    <meta name="twitter:description" content="Explore insulation assemblies and radiant barriers for tiny homes and vans.">
    <link rel="canonical" href="https://example.com/insulationexplorer.html">
    <link rel="icon" href="data:,">

    <script src="https://cdn.tailwindcss.com?plugins=typography"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="skin.css">
</head>
<body class="bg-gray-100 text-gray-800 font-sans">

    <div class="container mx-auto p-2 md:p-6 max-w-7xl">
        <header class="app-header text-center mb-6 relative">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-900">Insulation Explorer</h1>
            <p class="text-gray-700 mt-2">Design your wall or roof assembly to see how materials interact.</p>

            <!-- Hamburger Menu -->
            <div class="absolute top-0 right-0 p-4">
                <button id="menu-btn" class="text-gray-500 hover:text-gray-700 focus:outline-none" aria-label="Menu">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path>
                    </svg>
                </button>
                <div id="menu-dropdown" class="hidden absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg z-20">
                    <a href="index.html" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Tiny Home Calculator</a>
                    <a href="existing_building_estimator.html" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Existing Building Estimator</a>
                    <a href="insulationexplorer.html" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Insulation Explorer</a>
                </div>
            </div>
        </header>

        <div class="mb-6 text-center max-w-3xl mx-auto">
             <p class="text-sm text-gray-600">Pay special attention to <strong>Radiant Barriers</strong> which behave differently in summer (Heat Down) vs winter (Heat Up).</p>
        </div>

        <div class="explorer-container">
            <!-- Left: Visual Stack -->
            <div class="stack-section">
                <div class="heat-flow-arrow">
                    <span>‚òÄÔ∏è OUTSIDE (Hot/Cold)</span>
                </div>
                
                <div id="assembly-stack" class="assembly-stack shadow-lg">
                    <div class="assembly-header">Exterior Air Film</div>
                    <!-- Layers generate here -->
                </div>

                <div class="heat-flow-arrow">
                    <span>üè† INSIDE (Conditioned)</span>
                </div>
            </div>

            <!-- Right: Controls & Stats -->
            <div class="dashboard shadow-md" aria-live="polite">
                <div class="stat-card">
                    <div class="font-semibold text-gray-700">Effective R-Value</div>
                    <div style="display: flex; justify-content: space-around; margin-top:10px;">
                        <div>
                            <div class="stat-value" id="r-value-winter">0</div>
                            <div class="stat-sub">Winter (Heat Up)</div>
                        </div>
                        <div>
                            <div class="stat-value" id="r-value-summer">0</div>
                            <div class="stat-sub">Summer (Heat Down)</div>
                        </div>
                    </div>
                </div>

                <div id="inspector" class="inspector-panel rounded-md">
                    <strong>Inspector Notes:</strong><br>
                    Start by adding a structural layer or sheathing.
                </div>

                <div id="warnings" class="inspector-warning rounded-md" style="display:none;"></div>

                <h3 class="font-bold text-gray-700 mt-2">Add Layer</h3>
                <div class="add-menu">
                    <!-- Structure -->
                    <button class="add-btn shadow-sm transition-colors" onclick="addLayer('2x4 Stud (16oc)')" aria-label="Add 2x4 Wood Stud">üß± 2x4 Wood Stud</button>
                    <button class="add-btn shadow-sm transition-colors" onclick="addLayer('2x6 Stud (16oc)')" aria-label="Add 2x6 Wood Stud">üß± 2x6 Wood Stud</button>
                    <button class="add-btn shadow-sm transition-colors" onclick="addLayer('2x6 Roof Truss')" aria-label="Add 2x6 Roof Truss">üè† 2x6 Roof Truss</button>
                    <button class="add-btn shadow-sm transition-colors" onclick="addLayer('2x8 Joist')" aria-label="Add 2x8 Joist">üß± 2x8 Joist</button>
                    <button class="add-btn shadow-sm transition-colors" onclick="addLayer('2x10 Joist')" aria-label="Add 2x10 Joist">üß± 2x10 Joist</button>
                    
                    <!-- Insulation -->
                    <button class="add-btn shadow-sm transition-colors" onclick="addLayer('Fiberglass Batt (3.5in)')" aria-label="Add Fiberglass R-13">üß∂ Fiberglass R-13</button>
                    <button class="add-btn shadow-sm transition-colors" onclick="addLayer('Fiberglass Batt (5.5in)')" aria-label="Add Fiberglass R-21">üß∂ Fiberglass R-21</button>
                    <button class="add-btn shadow-sm transition-colors" onclick="addLayer('Basement Subfloor System')" aria-label="Add Basement Subfloor R-21+Reflectix">‚ú® Bsmt Subfloor (R-21+Refl)</button>
                    <button class="add-btn shadow-sm transition-colors" onclick="addLayer('Rockwool (3.5in)')" aria-label="Add Rockwool R-15">ü™® Rockwool R-15</button>
                    <button class="add-btn shadow-sm transition-colors" onclick="addLayer('Rockwool (5.5in)')" aria-label="Add Rockwool R-23">ü™® Rockwool R-23</button>
                    <button class="add-btn shadow-sm transition-colors" onclick="addLayer('Rockwool (7.25in)')" aria-label="Add Rockwool R-30">ü™® Rockwool R-30</button>
                    <button class="add-btn shadow-sm transition-colors" onclick="addLayer('XPS Rigid Foam (1in)')" aria-label="Add XPS Foam R-5">üü¶ XPS Foam (1")</button>
                    <button class="add-btn shadow-sm transition-colors" onclick="addLayer('Polyiso Board (1in)')" aria-label="Add Polyiso Foam R-6">üü® Polyiso Foam (1")</button>
                    
                    <!-- Radiant/Films -->
                    <button class="add-btn shadow-sm transition-colors" onclick="addLayer('Reflectix Radiant Barrier')" aria-label="Add Reflectix Layer">‚ú® Reflectix Layer</button>
                    <button class="add-btn shadow-sm transition-colors" onclick="addLayer('Air Gap (0.75in)')" aria-label="Add Air Gap">üí® Air Gap (3/4")</button>
                    <button class="add-btn shadow-sm transition-colors" onclick="addLayer('Poly Vapor Barrier')" aria-label="Add Poly Sheet">üõ°Ô∏è Poly Sheet</button>

                    <!-- Sheathing/Finish -->
                    <button class="add-btn shadow-sm transition-colors" onclick="addLayer('OSB Sheathing')" aria-label="Add OSB Sheathing">ü™µ OSB (1/2")</button>
                    <button class="add-btn shadow-sm transition-colors" onclick="addLayer('Drywall')" aria-label="Add Drywall">‚¨ú Drywall (1/2")</button>
                </div>
                
                <button class="button w-full mt-5 bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded shadow transition-colors" onclick="resetStack()">Reset Assembly</button>
            </div>
        </div>
        
        <div class="mt-10 bg-white p-6 rounded-lg shadow-md">
            <h2 class="text-xl font-bold text-gray-800 mb-4">üí° Pro Tips: Reflectix & Radiant Barriers</h2>
            <p class="mb-4 text-gray-700">Reflectix and other radiant barriers work by <strong>reflecting</strong> radiant heat, not just slowing conduction. For them to work, they MUST face an air space.</p>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="bg-green-50 p-4 rounded border border-green-200">
                    <h3 class="font-bold text-green-800 mb-2">‚úÖ Correct Installation</h3>
                    <p class="font-mono text-sm mb-2 bg-white p-1 rounded inline-block border border-green-100">Roof Deck -> Air Gap -> Reflectix -> Insulation</p>
                    <p class="text-sm text-gray-700">The foil surface faces an empty air gap (at least 0.75"). This allows the foil to reflect heat back up (summer) or emit very little heat down.</p>
                </div>
                <div class="bg-red-50 p-4 rounded border border-red-200">
                    <h3 class="font-bold text-red-800 mb-2">‚ùå Incorrect Installation</h3>
                    <p class="font-mono text-sm mb-2 bg-white p-1 rounded inline-block border border-red-100">Sandwiched (Zero Gap)</p>
                    <p class="text-sm text-gray-700">If you sandwich Reflectix between two solid layers (like roof deck and fiberglass) with no air gap, its R-value drops to ~1.1 (just the plastic bubbles). It becomes a conductor, not a reflector.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Logic Engine -->
    <script type="module" src="webmcp.js"></script>
    <script>
        // Database of Materials
        // r_per_inch: conductive resistance
        // type: category for logic
        // thickness: default thickness in inches
        const MATERIALS = {
            '2x4 Stud (16oc)': { r: 4.5, type: 'structure', thickness: 3.5, name: '2x4 Wood Stud Wall (16" o.c.)' },
            '2x6 Stud (16oc)': { r: 6.9, type: 'structure', thickness: 5.5, name: '2x6 Wood Stud Wall (16" o.c.)' },
            '2x10 Joist': { r: 11.25, type: 'structure', thickness: 9.25, name: '2x10 Roof Joist' },
            '2x6 Roof Truss': { r: 6.9, type: 'structure', thickness: 5.5, name: '2x6 Roof Truss' },
            '2x8 Joist': { r: 9.1, type: 'structure', thickness: 7.25, name: '2x8 Floor/Roof Joist' },
            'Fiberglass Batt (3.5in)': { r: 13, type: 'insulation', thickness: 3.5, name: 'Fiberglass Batt (R-13)' },
            'Fiberglass Batt (5.5in)': { r: 21, type: 'insulation', thickness: 5.5, name: 'Fiberglass Batt (R-21)' },
            'Basement Subfloor System': { r: 27, type: 'insulation', thickness: 5.5, name: 'Basement Subfloor (R-21 + Permeable Reflectix)' },
            'Rockwool (3.5in)': { r: 15, type: 'insulation', thickness: 3.5, name: 'Rockwool Safe\'n\'Sound (R-15)' },
            'Rockwool (5.5in)': { r: 23, type: 'insulation', thickness: 5.5, name: 'Rockwool ComfortBatt (R-23)' },
            'Rockwool (7.25in)': { r: 30, type: 'insulation', thickness: 7.25, name: 'Rockwool ComfortBatt (R-30)' },
            'XPS Rigid Foam (1in)': { r: 5.0, type: 'insulation', thickness: 1.0, name: 'XPS Rigid Foam (1")' },
            'Polyiso Board (1in)': { r: 6.0, type: 'insulation', thickness: 1.0, name: 'Foil-Faced Polyiso (1")' },
            'Reflectix Radiant Barrier': { r: 1.1, type: 'radiant', thickness: 0.3, name: 'Reflectix (Double Bubble)' },
            'Air Gap (0.75in)': { r: 0.9, type: 'air', thickness: 0.75, name: 'Dead Air Space (0.75")' },
            'Poly Vapor Barrier': { r: 0, type: 'vapor', thickness: 0.01, name: '6-mil Polyethylene' },
            'OSB Sheathing': { r: 0.6, type: 'sheathing', thickness: 0.5, name: 'OSB Sheathing (1/2")' },
            'Drywall': { r: 0.45, type: 'finish', thickness: 0.5, name: 'Gypsum Board (1/2")' }
        };

        // State
        let stack = [];

        function init() {
            // Pre-load a common scenario
            addLayer('OSB Sheathing');
            addLayer('2x6 Stud (16oc)');
            addLayer('Rockwool (5.5in)');
            addLayer('Drywall');
        }

        function addLayer(key) {
            const material = MATERIALS[key];
            if(!material) return;
            
            // Create a unique instance
            stack.push({
                ...material,
                id: Date.now() + Math.random()
            });
            render();
        }

        function removeLayer(id) {
            stack = stack.filter(l => l.id !== id);
            render();
        }

        function moveLayer(index, direction) {
            if (direction === -1 && index > 0) {
                [stack[index], stack[index - 1]] = [stack[index - 1], stack[index]];
            } else if (direction === 1 && index < stack.length - 1) {
                [stack[index], stack[index + 1]] = [stack[index + 1], stack[index]];
            }
            render();
        }

        function resetStack() {
            stack = [];
            render();
        }

        // The Physics Engine
        function calculate(currentStack = stack) {
            let totalR_winter = 0;
            let totalR_summer = 0;
            let warnings = [];
            let notes = [];
            
            // Basic air films (Exterior + Interior)
            totalR_winter += 0.85; 
            totalR_summer += 0.85; // simplified

            // Scan stack for context
            currentStack.forEach((layer, index) => {
                let r_up = layer.r; // Heat flow up (Winter)
                let r_down = layer.r; // Heat flow down (Summer)
                let layerNote = "";

                // --- LOGIC: Radiant Barriers ---
                if (layer.type === 'radiant') {
                    // Check neighbors for air gap
                    const prev = currentStack[index - 1];
                    const next = currentStack[index + 1];
                    const hasAirGap = (prev && prev.type === 'air') || (next && next.type === 'air');

                    if (hasAirGap) {
                        // Radiant Barrier ACTIVE
                        // Values approximate ASHRAE fundamentals for bright foil w/ air space
                        
                        // Heat Flow DOWN (Summer): Radiant barriers excel here
                        r_down = 10.0; // Effective R-value of the assembly boost
                        
                        // Heat Flow UP (Winter): Convection dominates, radiation less factor
                        r_up = 5.0; 
                        
                        layerNote = "ACTIVE (Reflecting Heat)";
                    } else {
                        // Radiant Barrier INACTIVE (Conduction only)
                        r_down = 1.1;
                        r_up = 1.1;
                        warnings.push(`Radiant layer at position ${index + 1} has no air gap! It is acting as a conductor only.`);
                        layerNote = "INACTIVE (No Air Gap)";
                    }
                }

                // --- LOGIC: Air Gaps ---
                if (layer.type === 'air') {
                    // Air gap R-value depends on facing surfaces. 
                    // If next to radiant, the radiant layer claims the bonus, keep air nominal
                    // to avoid double counting.
                    r_up = 0.9;
                    r_down = 0.9;
                }

                // --- LOGIC: Framing Factor (Thermal Bridging) ---
                // If we have insulation AND structure in the stack, we are strictly adding them linearly here
                // But in reality, studs bridge the insulation.
                // For this simple explorer, we will treat "Structure" layers as defining the cavity depth
                // If a user adds "2x6 Stud" AND "Rockwool", they are occupying the same space visually in this stacker
                // but physically they merge.
                // TO FIX: We will treat the stack as a literal sequence through the center of the bay, 
                // but warn if thickness doesn't match.
                
                totalR_winter += r_up;
                totalR_summer += r_down;
            });

            // Logic: Check thickness conflicts
            // E.g. 2x6 stud (5.5") + Rockwool (5.5") + Reflectix + Air Gap
            // If the user adds framing, we assume they are building the cavity. 
            // If total insulation thickness > structure thickness, warn.
            const structureLayer = currentStack.find(l => l.type === 'structure');
            const insulationThickness = currentStack.filter(l => l.type === 'insulation' || l.type === 'air').reduce((sum, l) => sum + l.thickness, 0);
            
            if (structureLayer && insulationThickness > structureLayer.thickness) {
                warnings.push(`<b>Compression Warning:</b> Your insulation + air gaps (${insulationThickness}") are thicker than your framing (${structureLayer.thickness}"). Compressing insulation reduces R-value and eliminates air gaps.`);
            }

            return { r_winter: totalR_winter.toFixed(1), r_summer: totalR_summer.toFixed(1), warnings, notes };
        }

        // WebMCP Tool Registration
        // Note: webmcp.js is loaded as a module, so this script might run before it initializes.
        // We can wait for it or just check if it's there.
        // A robust implementation would wait for the 'webmcp-ready' event if one existed,
        // or we can use a small timeout or assume the module loading order.
        // Since we are in an inline script at the bottom of the body, and webmcp.js is a module in the head (or start of body),
        // let's rely on window.navigator.modelContext being present if the polyfill is immediate,
        // OR simply wrap it in a timeout or event listener if the polyfill is async.
        // Looking at webmcp.js (from memory), it polyfills navigator.modelContext immediately if it's not dynamic import.

        window.addEventListener('load', () => {
             // Menu Toggle Logic
             const menuBtn = document.getElementById('menu-btn');
             const menuDropdown = document.getElementById('menu-dropdown');
             if (menuBtn && menuDropdown) {
                 menuBtn.addEventListener('click', (e) => {
                     e.stopPropagation();
                     menuDropdown.classList.toggle('hidden');
                 });
                 document.addEventListener('click', (event) => {
                    if (!menuDropdown.classList.contains('hidden') && !menuBtn.contains(event.target) && !menuDropdown.contains(event.target)) {
                        menuDropdown.classList.add('hidden');
                    }
                });
             }

             if (window.navigator && window.navigator.modelContext) {
                window.navigator.modelContext.registerTool({
                    name: "calculate_assembly",
                    description: "Calculate the effective R-value (Winter/Summer) of a wall or roof assembly given a list of layers.",
                    inputSchema: {
                        type: "object",
                        properties: {
                            layers: {
                                type: "array",
                                items: {
                                    type: "string",
                                    enum: Object.keys(MATERIALS),
                                    description: "The material key (e.g., '2x4 Stud (16oc)', 'Fiberglass Batt (3.5in)')"
                                },
                                description: "Ordered list of layers from Outside to Inside."
                            }
                        },
                        required: ["layers"]
                    },
                    execute: async (args) => {
                        const tempStack = args.layers.map(key => {
                            const mat = MATERIALS[key];
                            if (!mat) throw new Error(`Unknown material: ${key}`);
                            return { ...mat };
                        });
                        return calculate(tempStack);
                    }
                });
             }
        });

        function render() {
            const container = document.getElementById('assembly-stack');
            container.innerHTML = '<div class="assembly-header">Exterior Air Film</div>';

            stack.forEach((layer, index) => {
                const div = document.createElement('div');
                div.className = `layer layer-type-${layer.type}`;
                div.innerHTML = `
                    <div>
                        <strong>${layer.name}</strong><br>
                        <span style="font-size:0.8em">R-${layer.r} | ${layer.thickness}"</span>
                    </div>
                    <div class="layer-controls">
                        <button onclick="moveLayer(${index}, -1)" aria-label="Move Up">‚¨ÜÔ∏è</button>
                        <button onclick="moveLayer(${index}, 1)" aria-label="Move Down">‚¨áÔ∏è</button>
                        <button onclick="removeLayer(${layer.id})" style="color:red" aria-label="Remove Layer">√ó</button>
                    </div>
                `;
                container.appendChild(div);
            });

            const results = calculate();
            
            document.getElementById('r-value-winter').innerText = results.r_winter;
            document.getElementById('r-value-summer').innerText = results.r_summer;

            // Inspector
            const inspector = document.getElementById('inspector');
            const warningBox = document.getElementById('warnings');
            
            if (results.warnings.length > 0) {
                warningBox.style.display = 'block';
                warningBox.innerHTML = results.warnings.join('<br>');
            } else {
                warningBox.style.display = 'none';
            }

            // Contextual tips
            let tips = "System looks stable.";
            if (stack.some(l => l.type === 'radiant')) {
                tips = "Reflectix Tip: In a 2x6 roof truss, using a 'Double Reflectix' method (two layers with two air gaps) can effectively block summer heat, but takes up about 2.5 inches of space. Ensure you have room!";
            }
            if (stack.length === 0) tips = "Start adding layers to see results.";
            
            inspector.innerHTML = `<strong>Inspector Notes:</strong><br>${tips}`;
        }

        // Init
        init();

    </script>
    <script src="skin.js"></script>
</body>
</html>