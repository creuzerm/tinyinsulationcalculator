<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Insulation Explorer & Calculator</title>
    <meta name="description" content="Explore insulation assemblies and radiant barriers for tiny homes and vans. Visualize heat flow and effective R-values.">
    <meta property="og:title" content="Insulation Explorer & Calculator">
    <meta property="og:description" content="Explore insulation assemblies and radiant barriers for tiny homes and vans. Visualize heat flow and effective R-values.">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://example.com/insulationexplorer.html">
    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="Insulation Explorer & Calculator">
    <meta name="twitter:description" content="Explore insulation assemblies and radiant barriers for tiny homes and vans.">
    <link rel="canonical" href="https://example.com/insulationexplorer.html">
    <link rel="icon" href="data:,">

    <script src="https://cdn.tailwindcss.com?plugins=typography"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="skin.css">
</head>
<body class="bg-gray-100 text-gray-800 font-sans">

    <div class="container mx-auto p-2 md:p-6 max-w-7xl">
        <header class="app-header text-center mb-6 relative">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-900">Insulation Explorer</h1>
            <p class="text-gray-700 mt-2">Design your wall or roof assembly to see how materials interact.</p>

            <!-- Hamburger Menu -->
            <div class="absolute top-0 right-0 p-4">
                <button id="menu-btn" class="text-gray-500 hover:text-gray-700 focus:outline-none" aria-label="Menu">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path>
                    </svg>
                </button>
                <div id="menu-dropdown" class="hidden absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg z-20">
                    <a href="index.html" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Tiny Home Calculator</a>
                    <a href="existing_building_estimator.html" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Existing Building Estimator</a>
                    <a href="insulationexplorer.html" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Insulation Explorer</a>
                </div>
            </div>
        </header>

        <div class="mb-6 text-center max-w-3xl mx-auto">
             <p class="text-sm text-gray-600">Pay special attention to <strong>Radiant Barriers</strong> which behave differently in summer (Heat Down) vs winter (Heat Up).</p>
        </div>

        <div class="explorer-container">
            <!-- Left: Visual Stack -->
            <div class="stack-section">
                <div class="heat-flow-arrow">
                    <span>‚òÄÔ∏è OUTSIDE (Hot/Cold)</span>
                </div>
                
                <div id="assembly-stack" class="assembly-stack shadow-lg">
                    <div class="assembly-header">Exterior Air Film</div>
                    <!-- Layers generate here -->
                </div>

                <div class="heat-flow-arrow">
                    <span>üè† INSIDE (Conditioned)</span>
                </div>
            </div>

            <!-- Right: Controls & Stats -->
            <div class="dashboard shadow-md" aria-live="polite">
                <div class="stat-card">
                    <div class="font-semibold text-gray-700">Effective R-Value</div>
                    <div style="display: flex; justify-content: space-around; margin-top:10px;">
                        <div>
                            <div class="stat-value" id="r-value-winter">0</div>
                            <div class="stat-sub">Winter (Heat Up)</div>
                        </div>
                        <div>
                            <div class="stat-value" id="r-value-summer">0</div>
                            <div class="stat-sub">Summer (Heat Down)</div>
                        </div>
                    </div>
                </div>

                <div id="inspector" class="inspector-panel rounded-md">
                    <strong>Inspector Notes:</strong><br>
                    Start by adding a structural layer or sheathing.
                </div>

                <div id="warnings" class="inspector-warning rounded-md" style="display:none;"></div>

                <h3 class="font-bold text-gray-700 mt-2">Add Layer</h3>
                <div id="material-menu" class="add-menu">
                    <p class="col-span-full text-center text-gray-500 py-4">Loading materials...</p>
                </div>
                
                <button class="button w-full mt-5 bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded shadow transition-colors" onclick="resetStack()">Reset Assembly</button>
            </div>
        </div>
        
        <div class="mt-10 bg-white p-6 rounded-lg shadow-md">
            <h2 class="text-xl font-bold text-gray-800 mb-4">üí° Pro Tips: Reflectix & Radiant Barriers</h2>
            <p class="mb-4 text-gray-700">Reflectix and other radiant barriers work by <strong>reflecting</strong> radiant heat, not just slowing conduction. For them to work, they MUST face an air space.</p>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="bg-green-50 p-4 rounded border border-green-200">
                    <h3 class="font-bold text-green-800 mb-2">‚úÖ Correct Installation</h3>
                    <p class="font-mono text-sm mb-2 bg-white p-1 rounded inline-block border border-green-100">Roof Deck -> Air Gap -> Reflectix -> Insulation</p>
                    <p class="text-sm text-gray-700">The foil surface faces an empty air gap (at least 0.75"). This allows the foil to reflect heat back up (summer) or emit very little heat down.</p>
                </div>
                <div class="bg-red-50 p-4 rounded border border-red-200">
                    <h3 class="font-bold text-red-800 mb-2">‚ùå Incorrect Installation</h3>
                    <p class="font-mono text-sm mb-2 bg-white p-1 rounded inline-block border border-red-100">Sandwiched (Zero Gap)</p>
                    <p class="text-sm text-gray-700">If you sandwich Reflectix between two solid layers (like roof deck and fiberglass) with no air gap, its R-value drops to ~1.1 (just the plastic bubbles). It becomes a conductor, not a reflector.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Logic Engine -->
    <script type="module" src="webmcp.js"></script>
    <script>
        // Global Data
        let MATERIALS = {};
        let stack = [];

        // Fetch data and initialize
        async function loadMaterials() {
            try {
                const response = await fetch('materials.json');
                if (!response.ok) throw new Error('Failed to load materials.json');
                const data = await response.json();

                // Flatten the structured JSON into a single lookup object for calculation logic
                MATERIALS = {};
                const menuContainer = document.getElementById('material-menu');
                menuContainer.innerHTML = ''; // Clear loading message

                // Iterate through categories to build UI and lookup table
                for (const [category, items] of Object.entries(data)) {
                    // Create Category Header
                    const header = document.createElement('h4');
                    header.className = 'col-span-full font-semibold text-xs text-gray-500 uppercase tracking-wider mt-2 mb-1 border-b pb-1';
                    header.textContent = category;
                    menuContainer.appendChild(header);

                    // Create Buttons
                    for (const [key, material] of Object.entries(items)) {
                        // Add to lookup
                        MATERIALS[key] = material;

                        // Add Button (skip placeholders if desired, but here we render them if they are valid options)
                        // If placeholder property exists and is true, we might want to disable it or mark it.
                        // For now, per requirements, we just render them.
                        const btn = document.createElement('button');
                        btn.className = 'add-btn shadow-sm transition-colors';
                        btn.onclick = () => addLayer(key);
                        btn.setAttribute('aria-label', `Add ${material.name}`);

                        // Icon mapping based on type
                        let icon = "üß±";
                        if(material.type === 'insulation') icon = "üü¶";
                        if(material.name.includes("Fiberglass")) icon = "üß∂";
                        if(material.name.includes("Rockwool")) icon = "ü™®";
                        if(material.name.includes("Polyiso")) icon = "üü®";
                        if(material.name.includes("EPS")) icon = "‚¨ú";
                        if(material.name.includes("Spray")) icon = "üí®";
                        if(material.type === 'radiant') icon = "‚ú®";
                        if(material.type === 'air') icon = "üí®";
                        if(material.type === 'vapor') icon = "üõ°Ô∏è";
                        if(material.type === 'sheathing') icon = "ü™µ";
                        if(material.type === 'finish') icon = "‚¨ú";
                        if(key.includes("Roof")) icon = "üè†";

                        btn.innerText = `${icon} ${material.name.replace(/Rigid Foam|Board|Spray Foam|Batt|Safe'n'Sound|ComfortBatt/g, "").replace(/\(.*\)/, "").trim()} (${material.thickness}")`;

                        // Override concise labels for specific known items to match previous design if needed,
                        // or just use the generated one which is robust.
                        // Let's stick to the generated one for simplicity and consistency.

                        if (material.placeholder) {
                            btn.disabled = true;
                            btn.classList.add('opacity-50', 'cursor-not-allowed');
                            btn.title = "Coming Soon";
                        }

                        menuContainer.appendChild(btn);
                    }
                }

                // Initialize Default Stack
                initStack();

            } catch (error) {
                console.error(error);
                document.getElementById('material-menu').innerHTML = `<p class="col-span-full text-red-500">Error loading materials: ${error.message}</p>`;
            }
        }

        function initStack() {
            // Pre-load a common scenario
            addLayer('OSB Sheathing');
            addLayer('2x6 Stud (16oc)');
            addLayer('Rockwool (5.5in)');
            addLayer('Drywall');
        }

        function addLayer(key) {
            const material = MATERIALS[key];
            if(!material) return;
            
            // Create a unique instance
            stack.push({
                ...material,
                id: Date.now() + Math.random()
            });
            render();
        }

        // Start Loading and store promise
        const materialsLoadedPromise = loadMaterials();

        function removeLayer(id) {
            stack = stack.filter(l => l.id !== id);
            render();
        }

        function moveLayer(index, direction) {
            if (direction === -1 && index > 0) {
                [stack[index], stack[index - 1]] = [stack[index - 1], stack[index]];
            } else if (direction === 1 && index < stack.length - 1) {
                [stack[index], stack[index + 1]] = [stack[index + 1], stack[index]];
            }
            render();
        }

        function resetStack() {
            stack = [];
            render();
        }

        // The Physics Engine
        function calculate(currentStack = stack) {
            let totalR_winter = 0;
            let totalR_summer = 0;
            let warnings = [];
            let notes = [];
            
            // Basic air films (Exterior + Interior)
            totalR_winter += 0.85; 
            totalR_summer += 0.85; // simplified

            // Scan stack for context
            currentStack.forEach((layer, index) => {
                let r_up = layer.r; // Heat flow up (Winter)
                let r_down = layer.r; // Heat flow down (Summer)
                let layerNote = "";

                // --- LOGIC: Radiant Barriers ---
                if (layer.type === 'radiant') {
                    // Check neighbors for air gap
                    const prev = currentStack[index - 1];
                    const next = currentStack[index + 1];
                    const hasAirGap = (prev && prev.type === 'air') || (next && next.type === 'air');

                    if (hasAirGap) {
                        // Radiant Barrier ACTIVE
                        // Values approximate ASHRAE fundamentals for bright foil w/ air space
                        
                        // Heat Flow DOWN (Summer): Radiant barriers excel here
                        r_down = 10.0; // Effective R-value of the assembly boost
                        
                        // Heat Flow UP (Winter): Convection dominates, radiation less factor
                        r_up = 5.0; 
                        
                        layerNote = "ACTIVE (Reflecting Heat)";
                    } else {
                        // Radiant Barrier INACTIVE (Conduction only)
                        r_down = layer.r;
                        r_up = layer.r;
                        warnings.push(`Radiant layer at position ${index + 1} has no air gap! It is acting as a conductor only.`);
                        layerNote = "INACTIVE (No Air Gap)";
                    }
                }

                // --- LOGIC: Air Gaps ---
                if (layer.type === 'air') {
                    // Air gap R-value depends on facing surfaces. 
                    // If next to radiant, the radiant layer claims the bonus, keep air nominal
                    // to avoid double counting.
                    r_up = 0.9;
                    r_down = 0.9;
                }

                // --- LOGIC: Framing Factor (Thermal Bridging) ---
                // If we have insulation AND structure in the stack, we are strictly adding them linearly here
                // But in reality, studs bridge the insulation.
                // For this simple explorer, we will treat "Structure" layers as defining the cavity depth
                // If a user adds "2x6 Stud" AND "Rockwool", they are occupying the same space visually in this stacker
                // but physically they merge.
                // TO FIX: We will treat the stack as a literal sequence through the center of the bay, 
                // but warn if thickness doesn't match.
                
                totalR_winter += r_up;
                totalR_summer += r_down;
            });

            // Logic: Check thickness conflicts
            // E.g. 2x6 stud (5.5") + Rockwool (5.5") + Reflectix + Air Gap
            // If the user adds framing, we assume they are building the cavity. 
            // If total insulation thickness > structure thickness, warn.
            const structureLayer = currentStack.find(l => l.type === 'structure');
            const insulationThickness = currentStack.filter(l => l.type === 'insulation' || l.type === 'air').reduce((sum, l) => sum + l.thickness, 0);
            
            if (structureLayer && insulationThickness > structureLayer.thickness) {
                warnings.push(`<b>Compression Warning:</b> Your insulation + air gaps (${insulationThickness}") are thicker than your framing (${structureLayer.thickness}"). Compressing insulation reduces R-value and eliminates air gaps.`);
            }

            return { r_winter: totalR_winter.toFixed(1), r_summer: totalR_summer.toFixed(1), warnings, notes };
        }

        // WebMCP Tool Registration
        // Note: webmcp.js is loaded as a module, so this script might run before it initializes.
        // We can wait for it or just check if it's there.
        // A robust implementation would wait for the 'webmcp-ready' event if one existed,
        // or we can use a small timeout or assume the module loading order.
        // Since we are in an inline script at the bottom of the body, and webmcp.js is a module in the head (or start of body),
        // let's rely on window.navigator.modelContext being present if the polyfill is immediate,
        // OR simply wrap it in a timeout or event listener if the polyfill is async.
        // Looking at webmcp.js (from memory), it polyfills navigator.modelContext immediately if it's not dynamic import.

        window.addEventListener('load', async () => {
             // Wait for materials to load so tool registration has correct enum
             await materialsLoadedPromise;

             // Menu Toggle Logic
             const menuBtn = document.getElementById('menu-btn');
             const menuDropdown = document.getElementById('menu-dropdown');
             if (menuBtn && menuDropdown) {
                 menuBtn.addEventListener('click', (e) => {
                     e.stopPropagation();
                     menuDropdown.classList.toggle('hidden');
                 });
                 document.addEventListener('click', (event) => {
                    if (!menuDropdown.classList.contains('hidden') && !menuBtn.contains(event.target) && !menuDropdown.contains(event.target)) {
                        menuDropdown.classList.add('hidden');
                    }
                });
             }

             if (window.navigator && window.navigator.modelContext) {
                window.navigator.modelContext.registerTool({
                    name: "calculate_assembly",
                    description: "Calculate the effective R-value (Winter/Summer) of a wall or roof assembly given a list of layers.",
                    inputSchema: {
                        type: "object",
                        properties: {
                            layers: {
                                type: "array",
                                items: {
                                    type: "string",
                                    enum: Object.keys(MATERIALS),
                                    description: "The material key (e.g., '2x4 Stud (16oc)', 'Fiberglass Batt (3.5in)')"
                                },
                                description: "Ordered list of layers from Outside to Inside."
                            }
                        },
                        required: ["layers"]
                    },
                    execute: async (args) => {
                        const tempStack = args.layers.map(key => {
                            const mat = MATERIALS[key];
                            if (!mat) throw new Error(`Unknown material: ${key}`);
                            return { ...mat };
                        });
                        return calculate(tempStack);
                    }
                });
             }
        });

        function render() {
            const container = document.getElementById('assembly-stack');
            container.innerHTML = '<div class="assembly-header">Exterior Air Film</div>';

            stack.forEach((layer, index) => {
                const div = document.createElement('div');
                div.className = `layer layer-type-${layer.type}`;
                div.innerHTML = `
                    <div>
                        <strong>${layer.name}</strong><br>
                        <span style="font-size:0.8em">R-${layer.r} | ${layer.thickness}"</span>
                    </div>
                    <div class="layer-controls">
                        <button onclick="moveLayer(${index}, -1)" aria-label="Move Up">‚¨ÜÔ∏è</button>
                        <button onclick="moveLayer(${index}, 1)" aria-label="Move Down">‚¨áÔ∏è</button>
                        <button onclick="removeLayer(${layer.id})" style="color:red" aria-label="Remove Layer">√ó</button>
                    </div>
                `;
                container.appendChild(div);
            });

            const results = calculate();
            
            document.getElementById('r-value-winter').innerText = results.r_winter;
            document.getElementById('r-value-summer').innerText = results.r_summer;

            // Inspector
            const inspector = document.getElementById('inspector');
            const warningBox = document.getElementById('warnings');
            
            if (results.warnings.length > 0) {
                warningBox.style.display = 'block';
                warningBox.innerHTML = results.warnings.join('<br>');
            } else {
                warningBox.style.display = 'none';
            }

            // Contextual tips
            let tips = "System looks stable.";
            if (stack.some(l => l.type === 'radiant')) {
                tips = "Reflectix Tip: In a 2x6 roof truss, using a 'Double Reflectix' method (two layers with two air gaps) can effectively block summer heat, but takes up about 2.5 inches of space. Ensure you have room!";
            }
            if (stack.length === 0) tips = "Start adding layers to see results.";
            
            inspector.innerHTML = `<strong>Inspector Notes:</strong><br>${tips}`;
        }


    </script>
    <script src="skin.js"></script>
</body>
</html>