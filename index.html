<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tiny Home Heat Loss Calculator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .input-group {
            margin-bottom: 1.5rem;
        }
        .input-label {
            display: block;
            margin-bottom: 0.5rem;
            color: #4A5568;
            font-weight: 500;
        }
        .input-field {
            width: 100%;
            padding: 0.75rem;
            border-radius: 0.375rem;
            border: 1px solid #E2E8F0;
            background-color: #F7FAFC;
            transition: border-color 0.2s;
        }
        .input-field:focus {
            outline: none;
            border-color: #4299E1;
            box-shadow: 0 0 0 1px #4299E1;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <div class="container mx-auto p-4 md:p-8 max-w-4xl">
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-900">Tiny Home Heat Loss Calculator</h1>
            <p class="text-gray-600 mt-2">Estimate the heating load for your tiny home to size your heat pump correctly.</p>
        </header>

        <main class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- Input Controls Column -->
            <div class="bg-white p-6 rounded-lg shadow-md">
                <h2 class="text-2xl font-semibold mb-6 border-b pb-3">Building Specifications</h2>

                <!-- Building Shape Selector -->
                <div class="input-group">
                    <label for="buildingShape" class="input-label">Building Shape</label>
                    <select id="buildingShape" class="input-field">
                        <option value="rectangle">Simple Rectangle</option>
                        <option value="a-frame">A-Frame</option>
                        <option value="gothic-arch">Gothic Arch</option>
                    </select>
                </div>

                <!-- Dimension Inputs -->
                <div id="dimensionInputs">
                    <!-- Dynamic inputs will be injected here by JS -->
                </div>

                <h2 class="text-2xl font-semibold mb-6 mt-8 border-b pb-3">Climate & Comfort</h2>

                <!-- Temperature Inputs -->
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 input-group">
                    <div>
                        <label for="indoorTemp" class="input-label">Indoor Temp (°F)</label>
                        <input type="number" id="indoorTemp" class="input-field" value="68">
                    </div>
                    <div>
                        <label for="outdoorTemp" class="input-label">Outdoor Temp (°F)</label>
                        <input type="number" id="outdoorTemp" class="input-field" value="10">
                    </div>
                </div>

                <h2 class="text-2xl font-semibold mb-6 mt-8 border-b pb-3">Construction Details</h2>

                <!-- Wall Assembly Selector -->
                <div class="input-group">
                    <label for="wallAssembly" class="input-label">Insulation / Wall</label>
                    <select id="wallAssembly" class="input-field">
                        <option value="13">2x4 Walls (R-13)</option>
                        <option value="21">2x6 Walls (R-21)</option>
                        <option value="29">2x8 Walls (R-29)</option>
                        <option value="custom">Custom R-Value</option>
                        <option value="double-wall">Double Stud Wall (No Thermal Bridge)</option>
                    </select>
                </div>
                <div id="customRValueContainer" class="input-group hidden">
                    <label for="customRValue" class="input-label">Custom Wall R-Value</label>
                    <input type="number" id="customRValue" class="input-field" value="21">
                </div>
                 <div id="doubleWallContainer" class="input-group hidden">
                    <label for="doubleWallRValue" class="input-label">Double Wall Insulation R-Value</label>
                    <input type="number" id="doubleWallRValue" class="input-field" value="40">
                </div>

                <!-- Openings Selector -->
                <div class="input-group">
                    <label for="openingsArea" class="input-label">Openings (Windows & Doors)</label>
                    <select id="openingsArea" class="input-field">
                        <option value="10">10% of Surface Area (Minimal)</option>
                        <option value="15" selected>15% of Surface Area (Common)</option>
                        <option value="20">20% of Surface Area (Generous)</option>
                        <option value="25">25% of Surface Area (Lots of Glass)</option>
                    </select>
                </div>

                <h2 class="text-2xl font-semibold mb-6 mt-8 border-b pb-3">Qualitative Factors</h2>

                <!-- Qualitative Factors -->
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 input-group">
                    <div>
                        <label for="airSealing" class="input-label">Air Sealing</label>
                        <select id="airSealing" class="input-field">
                            <option value="good">Good Air Barrier</option>
                            <option value="poor">Poor Air Barrier (Drafty)</option>
                        </select>
                    </div>
                    <div>
                        <label for="radiantBarrier" class="input-label">Radiant Barrier</label>
                        <select id="radiantBarrier" class="input-field">
                            <option value="no">No Reflective Barrier</option>
                            <option value="yes">Reflective Barrier Included</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Results Column -->
            <div class="bg-white p-6 rounded-lg shadow-md flex flex-col">
                <h2 class="text-2xl font-semibold mb-6 border-b pb-3">Estimated Heat Loss</h2>
                <div class="flex-grow flex flex-col items-center justify-center text-center">
                    <div id="resultsDisplay" class="mb-4">
                        <p class="text-6xl font-bold text-blue-600">0</p>
                        <p class="text-xl text-gray-600">BTUs/hr</p>
                    </div>
                    <p id="resultsExplanation" class="max-w-md text-gray-500">
                        This is the approximate heating power your system needs to maintain the desired indoor temperature on the coldest day. Look for a heat pump with a capacity that meets or exceeds this value.
                    </p>
                </div>
                 <div class="mt-8">
                    <h3 class="text-xl font-semibold text-center mb-4">Heat Loss vs. Outdoor Temperature</h3>
                    <canvas id="heatLossChart"></canvas>
                </div>

                <!-- New Section for Heat Loss Breakdown Table -->
                <div id="heatLossBreakdownContainer" class="mt-8 pt-6 border-t">
                    <h3 class="text-xl font-semibold text-center mb-4">Heat Loss Breakdown by Surface</h3>
                    <div id="heatLossBreakdownTable" class="overflow-x-auto">
                        <!-- Table will be injected here by JS -->
                        <p class="text-center text-gray-500">Calculating breakdown...</p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DOM Element References ---
            const buildingShape = document.getElementById('buildingShape');
            const dimensionInputsContainer = document.getElementById('dimensionInputs');
            const indoorTemp = document.getElementById('indoorTemp');
            const outdoorTemp = document.getElementById('outdoorTemp');
            const wallAssembly = document.getElementById('wallAssembly');
            const customRValueContainer = document.getElementById('customRValueContainer');
            const customRValue = document.getElementById('customRValue');
            const doubleWallContainer = document.getElementById('doubleWallContainer');
            const doubleWallRValue = document.getElementById('doubleWallRValue');
            const openingsArea = document.getElementById('openingsArea');
            const airSealing = document.getElementById('airSealing');
            const radiantBarrier = document.getElementById('radiantBarrier');
            const resultsDisplay = document.getElementById('resultsDisplay').querySelector('p:first-child');

            let heatLossChart;

            // --- Dimension Templates ---
            const dimensionTemplates = {
                rectangle: `
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 input-group">
                        <div><label class="input-label">Length (ft)</label><input type="number" id="length" class="input-field" value="20"></div>
                        <div><label class="input-label">Width (ft)</label><input type="number" id="width" class="input-field" value="10"></div>
                        <div><label class="input-label">Height (ft)</label><input type="number" id="height" class="input-field" value="8"></div>
                    </div>
                    <div class="input-group">
                        <label for="roofPitch" class="input-label">Roof Pitch (e.g., 4 for 4/12)</label>
                        <input type="number" id="roofPitch" class="input-field" value="4">
                        <small class="text-gray-500">For under-roof insulation calculation.</small>
                    </div>
                `,
                'a-frame': `
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 input-group">
                        <div><label class="input-label">Length (ft)</label><input type="number" id="length" class="input-field" value="20"></div>
                        <div><label class="input-label">Base Width (ft)</label><input type="number" id="width" class="input-field" value="12"></div>
                        <div><label class="input-label">Height (ft)</label><input type="number" id="height" class="input-field" value="15"></div>
                    </div>
                `,
                'gothic-arch': `
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 input-group">
                        <div><label class="input-label">Length (ft)</label><input type="number" id="length" class="input-field" value="20"></div>
                        <div><label class="input-label">Width (ft)</label><input type="number" id="width" class="input-field" value="12"></div>
                         <div><label class="input-label">Spring Wall Ht (ft)</label><input type="number" id="springWallHeight" class="input-field" value="2"></div>
                    </div>
                `
            };

            // --- Functions ---

            function calculateHeatLossForTemperature(deltaT, surfaceAreas, combinedRVal, openingsRVal, openingsFractionVal, airSealingValue) {
                let componentLosses = {
                    totalLoss: 0,
                    wallLoss: 0,
                    roofLoss: 0,
                    endWallLoss: 0,
                    openingsLoss: 0 // Combined loss from all openings
                };

                let currentTotalLossPrePenalty = 0;

                // Calculate loss through INSULATED portion of Walls
                if (surfaceAreas.wall > 0) {
                    const wallInsulatedArea = surfaceAreas.wall * (1 - openingsFractionVal);
                    const insulatedWallLoss = (combinedRVal > 0) ? (wallInsulatedArea * deltaT) / combinedRVal : 0;
                    componentLosses.wallLoss = airSealingValue === 'poor' ? insulatedWallLoss * 1.25 : insulatedWallLoss;
                    currentTotalLossPrePenalty += insulatedWallLoss;
                }

                // Calculate loss through INSULATED portion of Roof
                if (surfaceAreas.roof > 0) {
                    const roofInsulatedArea = surfaceAreas.roof * (1 - openingsFractionVal);
                    const insulatedRoofLoss = (combinedRVal > 0) ? (roofInsulatedArea * deltaT) / combinedRVal : 0;
                    componentLosses.roofLoss = airSealingValue === 'poor' ? insulatedRoofLoss * 1.25 : insulatedRoofLoss;
                    currentTotalLossPrePenalty += insulatedRoofLoss;
                }

                // Calculate loss through INSULATED portion of End Walls
                if (surfaceAreas.endWall > 0) {
                    const endWallInsulatedArea = surfaceAreas.endWall * (1 - openingsFractionVal);
                    const insulatedEndWallLoss = (combinedRVal > 0) ? (endWallInsulatedArea * deltaT) / combinedRVal : 0;
                    componentLosses.endWallLoss = airSealingValue === 'poor' ? insulatedEndWallLoss * 1.25 : insulatedEndWallLoss;
                    currentTotalLossPrePenalty += insulatedEndWallLoss;
                }

                // Calculate loss through ALL Openings (sum of openings in walls, roof, endwalls)
                const totalOpeningAreaOverall = surfaceAreas.total * openingsFractionVal;
                const totalOpeningsHeatLoss = (openingsRVal > 0 && totalOpeningAreaOverall > 0) ? (totalOpeningAreaOverall * deltaT) / openingsRVal : 0;
                componentLosses.openingsLoss = airSealingValue === 'poor' ? totalOpeningsHeatLoss * 1.25 : totalOpeningsHeatLoss;
                currentTotalLossPrePenalty += totalOpeningsHeatLoss;

                // Apply air sealing penalty for the total loss
                componentLosses.totalLoss = currentTotalLossPrePenalty;
                if (airSealingValue === 'poor') {
                    componentLosses.totalLoss *= 1.25;
                }

                // Round all losses
                for (let key in componentLosses) {
                    componentLosses[key] = Math.round(componentLosses[key]);
                }

                return componentLosses;
            }

            function updateDimensionInputs() {
                dimensionInputsContainer.innerHTML = dimensionTemplates[buildingShape.value];
                attachInputListeners();
                calculateAll();
            }

            function getWallRValue() {
                let rValue = parseFloat(wallAssembly.value);
                if (wallAssembly.value === 'custom') {
                    customRValueContainer.classList.remove('hidden');
                    doubleWallContainer.classList.add('hidden');
                    rValue = parseFloat(customRValue.value) || 0;
                } else if (wallAssembly.value === 'double-wall') {
                    customRValueContainer.classList.add('hidden');
                    doubleWallContainer.classList.remove('hidden');
                    rValue = parseFloat(doubleWallRValue.value) || 0;
                } else {
                    customRValueContainer.classList.add('hidden');
                    doubleWallContainer.classList.add('hidden');
                }

                if (radiantBarrier.value === 'yes') {
                    rValue += 3;
                }
                return rValue;
            }

            function calculateSurfaceArea() {
                const shape = buildingShape.value;
                const L = parseFloat(document.getElementById('length')?.value) || 0;
                const W = parseFloat(document.getElementById('width')?.value) || 0;
                const H = parseFloat(document.getElementById('height')?.value) || 0; // For rectangle, eave height. For A-frame, overall peak height.
                const SWH = parseFloat(document.getElementById('springWallHeight')?.value) || 0; // For Gothic Arch

                let areas = {
                    total: 0,
                    wall: 0,        // Vertical walls (rectangle main walls, gothic spring walls)
                    roof: 0,        // Pitched/flat roof (rectangle), sloped surfaces (a-frame main), curved roof (gothic)
                    endWall: 0,     // Gable ends (rectangle), triangular ends (a-frame), semi-circular ends (gothic)
                                    // Note: For A-frame, 'roof' includes the primary sloped surfaces that function as walls+roof.
                                    // 'endWall' is for the typically triangular end caps.
                };

                switch (shape) {
                    case 'rectangle': {
                        const roofPitchValue = parseFloat(document.getElementById('roofPitch')?.value);
                        const roofPitch = !isNaN(roofPitchValue) && roofPitchValue >= 0 ? roofPitchValue : 0;

                        // Vertical walls (sum of 2*L*H and 2*W*H)
                        areas.wall = (2 * L * H) + (2 * W * H);

                        if (roofPitch === 0) { // Flat roof
                            areas.roof = L * W;
                            areas.endWall = 0; // No gables for a truly flat roof from these definitions
                        } else { // Pitched roof
                            const gableHeight = (W / 2) * (roofPitch / 12);
                            const rafterLength = Math.sqrt(Math.pow(W / 2, 2) + Math.pow(gableHeight, 2));
                            areas.roof = L * rafterLength * 2;
                            // Gable end walls (triangular part above the main H of the end walls)
                            // These are part of the 'endWall' category, distinct from the main 'wall' area.
                            areas.endWall = 2 * (0.5 * W * gableHeight);
                        }
                        break;
                    }
                    case 'a-frame': {
                        // H is the total height from base to peak. W is base width.
                        const slopeHeight = Math.sqrt(Math.pow(W / 2, 2) + Math.pow(H, 2));
                        areas.roof = 2 * L * slopeHeight; // These are the main sloped surfaces (roof/wall combined)

                        areas.endWall = 2 * (0.5 * W * H); // Triangular end walls
                        areas.wall = 0; // No separate vertical 'side' walls in a pure A-frame.
                        break;
                    }
                    case 'gothic-arch': {
                        // W is the full width of the arch base. SWH is height of vertical spring walls.
                        const radius = W / 2;

                        const archPerimeterSegment = Math.PI * radius; // Length of the arch (half circumference)
                        areas.roof = L * archPerimeterSegment; // Curved roof surface area

                        areas.endWall = Math.PI * Math.pow(radius, 2); // Area of two semi-circular end walls = one full circle

                        areas.wall = 2 * L * SWH; // Area of vertical spring walls (if SWH > 0)
                        break;
                    }
                }

                // Ensure all components are numbers and sum them for the total
                areas.wall = isNaN(areas.wall) ? 0 : areas.wall;
                areas.roof = isNaN(areas.roof) ? 0 : areas.roof;
                areas.endWall = isNaN(areas.endWall) ? 0 : areas.endWall;

                areas.total = areas.wall + areas.roof + areas.endWall;
                if (isNaN(areas.total)) areas.total = 0;

                return areas;
            }

            function calculateAll() {
                const surfaceAreas = calculateSurfaceArea(); // surfaceAreas is now an object: {total, wall, roof, endWall}

                if (!surfaceAreas || surfaceAreas.total <= 0) {
                    resultsDisplay.textContent = '0';
document.getElementById('heatLossBreakdownTable').innerHTML = '<p class="text-center text-gray-500">Enter valid dimensions to see breakdown.</p>';
if (heatLossChart) {
    heatLossChart.data.labels = [];
    heatLossChart.data.datasets = [];
    heatLossChart.update();
}
                    return;
                }

                const deltaT = Math.abs(parseFloat(indoorTemp.value) - parseFloat(outdoorTemp.value));
                const combinedRVal = getWallRValue();
                const openingsRVal = 3; // Standard R-value for double-pane openings
                const openingsFractionVal = parseFloat(openingsArea.value) / 100;
                const airSealingValue = airSealing.value;

                const heatLosses = calculateHeatLossForTemperature(
                    deltaT,
                    surfaceAreas,
                    combinedRVal,
                    openingsRVal,
                    openingsFractionVal,
                    airSealingValue
                );

                let breakdown = {
                    components: [],
                    totalLoss: heatLosses.totalLoss,
                    totalArea: surfaceAreas.total
                };

                // Populate breakdown.components
                // Note: The individual component losses from calculateHeatLossForTemperature already include the air sealing factor.
                // The percentage calculation will be based on these already-adjusted losses.

                if (surfaceAreas.wall > 0) {
                    breakdown.components.push({
                        name: "Walls",
                        area: surfaceAreas.wall,
                        heatLoss: heatLosses.wallLoss, // This is (insulated wall loss * penalty)
                        percentageOfTotalLoss: 0
                    });
                }
                if (surfaceAreas.roof > 0) {
                    breakdown.components.push({
                        name: "Roof",
                        area: surfaceAreas.roof,
                        heatLoss: heatLosses.roofLoss, // This is (insulated roof loss * penalty)
                        percentageOfTotalLoss: 0
                    });
                }
                if (surfaceAreas.endWall > 0) {
                    breakdown.components.push({
                        name: "End Walls/Gables",
                        area: surfaceAreas.endWall,
                        heatLoss: heatLosses.endWallLoss, // This is (insulated end wall loss * penalty)
                        percentageOfTotalLoss: 0
                    });
                }
                 // Add openings as a separate category in the breakdown
                const totalOpeningAreaOverall = surfaceAreas.total * openingsFractionVal;
                if (totalOpeningAreaOverall > 0) {
                    breakdown.components.push({
                        name: "Openings (Windows/Doors)",
                        area: totalOpeningAreaOverall, // Show total opening area
                        heatLoss: heatLosses.openingsLoss, // This is (total openings loss * penalty)
                        percentageOfTotalLoss: 0
                    });
                }


                // Calculate percentageOfTotalLoss for each component
                if (breakdown.totalLoss > 0) {
                    breakdown.components.forEach(comp => {
                        comp.percentageOfTotalLoss = (comp.heatLoss / breakdown.totalLoss) * 100;
                    });
                } else {
                     breakdown.components.forEach(comp => comp.percentageOfTotalLoss = 0);
                }

                resultsDisplay.textContent = Math.round(breakdown.totalLoss).toLocaleString();

                updateHeatLossBreakdownTable(breakdown);

                updateChart(surfaceAreas); // Pass the surfaceAreas object for charting
            }

            function updateHeatLossBreakdownTable(breakdown) {
                const tableContainer = document.getElementById('heatLossBreakdownTable');
                if (!tableContainer) return;

                if (!breakdown || !breakdown.components || breakdown.components.length === 0) {
                    tableContainer.innerHTML = '<p class="text-center text-gray-500">No breakdown data available. Adjust inputs.</p>';
                    return;
                }

                let tableHTML = `
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Surface</th>
                                <th scope="col" class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Area (sq ft)</th>
                                <th scope="col" class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Heat Loss (BTU/hr)</th>
                                <th scope="col" class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">% of Total</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                `;

                breakdown.components.forEach(comp => {
                    if (comp.area > 0) { // Only display components with area
                        tableHTML += `
                            <tr>
                                <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-900">${comp.name}</td>
                                <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500 text-right">${Math.round(comp.area).toLocaleString()}</td>
                                <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500 text-right">${Math.round(comp.heatLoss).toLocaleString()}</td>
                                <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500 text-right">${comp.percentageOfTotalLoss.toFixed(1)}%</td>
                            </tr>
                        `;
                    }
                });

                // Add a footer row for totals, excluding individual component opening/insulated areas
                tableHTML += `
                        </tbody>
                        <tfoot class="bg-gray-50">
                            <tr>
                                <td class="px-4 py-3 text-left text-sm font-bold text-gray-700">Total</td>
                                <td class="px-4 py-3 text-right text-sm font-bold text-gray-700">${Math.round(breakdown.totalArea).toLocaleString()}</td>
                                <td class="px-4 py-3 text-right text-sm font-bold text-gray-700">${Math.round(breakdown.totalLoss).toLocaleString()}</td>
                                <td class="px-4 py-3 text-right text-sm font-bold text-gray-700">100.0%</td>
                            </tr>
                        </tfoot>
                    </table>
                `;

                tableContainer.innerHTML = tableHTML;
            }

function updateChart(surfaceAreas) { // surfaceAreas is now passed as a parameter
                const tempLabels = [];
                const datasets = [];
                const startTemp = parseFloat(outdoorTemp.value);
                const currentIndoorTemp = parseFloat(indoorTemp.value);
                const maxTemp = 90;

                // const surfaceAreas = calculateSurfaceArea(); // This line is removed

                if (surfaceAreas.total <= 0) {
                    if (heatLossChart) {
                        heatLossChart.data.labels = [];
                        heatLossChart.data.datasets = [];
                        heatLossChart.update();
                    }
                    return;
                }

                // Define colors for different datasets
                const colors = {
                    total: 'rgba(54, 162, 235, 1)',
                    walls: 'rgba(255, 99, 132, 1)',
                    roof: 'rgba(75, 192, 192, 1)',
                    endWalls: 'rgba(255, 206, 86, 1)',
                    openings: 'rgba(153, 102, 255, 1)'
                };
                const backgroundColors = {
                    total: 'rgba(54, 162, 235, 0.2)',
                    walls: 'rgba(255, 99, 132, 0.2)',
                    roof: 'rgba(75, 192, 192, 0.2)',
                    endWalls: 'rgba(255, 206, 86, 0.2)',
                    openings: 'rgba(153, 102, 255, 0.2)'
                };

                // Initialize data arrays for each component and total
                let totalHeatLossData = [];
                let wallHeatLossData = [];
                let roofHeatLossData = [];
                let endWallHeatLossData = [];
                let openingsHeatLossData = []; // Combined loss from all openings

                const combinedRVal = getWallRValue();
                const openingsRVal = 3;
                const openingsFractionVal = parseFloat(openingsArea.value) / 100;
                const airSealingValue = airSealing.value;

                for (let temp = startTemp; temp <= maxTemp; temp += 10) {
                    tempLabels.push(`${temp}°F`);
                    const deltaT = Math.abs(currentIndoorTemp - temp);

                    const heatLosses = calculateHeatLossForTemperature(
                        deltaT,
                        surfaceAreas,
                        combinedRVal,
                        openingsRVal,
                        openingsFractionVal,
                        airSealingValue
                    );

                    totalHeatLossData.push(heatLosses.totalLoss);
                    wallHeatLossData.push(heatLosses.wallLoss);
                    roofHeatLossData.push(heatLosses.roofLoss);
                    endWallHeatLossData.push(heatLosses.endWallLoss);
                    openingsHeatLossData.push(heatLosses.openingsLoss);
                }

                // Prepare datasets for Chart.js
                datasets.push({
                    label: 'Total Heat Loss', data: totalHeatLossData,
                    borderColor: colors.total, backgroundColor: backgroundColors.total,
                    borderWidth: 3, fill: true, tension: 0.1, type: 'line'
                });
                if (surfaceAreas.wall > 0) { // Only add dataset if wall area exists
                    datasets.push({
                        label: 'Insulated Wall Loss', data: wallHeatLossData, // Changed label
                        borderColor: colors.walls, backgroundColor: backgroundColors.walls,
                        borderWidth: 1.5, fill: false, tension: 0.1, type: 'line', hidden: true
                    });
                }
                if (surfaceAreas.roof > 0) { // Only add dataset if roof area exists
                    datasets.push({
                        label: 'Insulated Roof Loss', data: roofHeatLossData, // Changed label
                        borderColor: colors.roof, backgroundColor: backgroundColors.roof,
                        borderWidth: 1.5, fill: false, tension: 0.1, type: 'line', hidden: true
                    });
                }
                if (surfaceAreas.endWall > 0) { // Only add dataset if endWall area exists
                     datasets.push({
                        label: 'Insulated End Wall/Gable Loss', data: endWallHeatLossData, // Changed label
                        borderColor: colors.endWalls, backgroundColor: backgroundColors.endWalls,
                        borderWidth: 1.5, fill: false, tension: 0.1, type: 'line', hidden: true
                    });
                }
                if (openingsFractionVal > 0) { // Only add dataset if there are openings
                    datasets.push({
                        label: 'Total Openings Loss', data: openingsHeatLossData, // Changed label
                        borderColor: colors.openings, backgroundColor: backgroundColors.openings,
                        borderWidth: 1.5, fill: false, tension: 0.1, type: 'line', hidden: true
                    });
                }


                if (!heatLossChart) {
                    const ctx = document.getElementById('heatLossChart').getContext('2d');
                    heatLossChart = new Chart(ctx, {
                        // type: 'line', // Type can be defined per dataset
                        data: {
                            labels: tempLabels,
                            datasets: datasets
                        },
                        options: {
                             responsive: true,
                             maintainAspectRatio: true,
                             scales: {
                                 y: {
                                     beginAtZero: true,
                                     title: { display: true, text: 'BTU/hr' }
                                 },
                                 x: {
                                      title: { display: true, text: 'Outdoor Temperature' }
                                 }
                             },
                             plugins: {
                                legend: {
                                    display: true // Will be needed for multiple datasets
                                },
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            return ` ${context.dataset.label}: ${context.raw.toLocaleString()} BTU/hr`;
                                        }
                                    }
                                }
                             }
                        }
                    });
                } else {
                     heatLossChart.data.labels = tempLabels;
heatLossChart.data.datasets = datasets;
                     heatLossChart.update();
                }
            }

            function attachInputListeners() {
                const inputs = document.querySelectorAll('.input-field, input[type="number"]');
                inputs.forEach(input => {
                    input.removeEventListener('input', calculateAll); // Remove existing to prevent duplicates if run multiple times
                    input.removeEventListener('change', calculateAll);
                    input.addEventListener('input', calculateAll);
                    input.addEventListener('change', calculateAll);
                });
            }

            // --- Initial Setup ---
            buildingShape.addEventListener('change', () => {
                updateDimensionInputs(); // This already calls calculateAll
            });
            wallAssembly.addEventListener('change', calculateAll);
            customRValue.addEventListener('input', calculateAll);
            doubleWallRValue.addEventListener('input', calculateAll);
            openingsArea.addEventListener('change', calculateAll);
            airSealing.addEventListener('change', calculateAll);
            radiantBarrier.addEventListener('change', calculateAll);
            indoorTemp.addEventListener('input', calculateAll);
            outdoorTemp.addEventListener('input', calculateAll);

            updateDimensionInputs(); // Initial call to set default dimensions and perform first calculation
        });
    </script>
</body>
</html>
